<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>2026液態靈魂收集冊</title>
    <!-- 核心套件載入 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDK 相容版 -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { -webkit-tap-highlight-color: transparent; background-color: #FDFCF8; margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .stats-text-label { font-size: 17px; }
        .stats-text-value { font-size: 1.85rem; line-height: 1; }
        @media (min-width: 768px) {
            .stats-text-label { font-size: 20px; }
            .stats-text-value { font-size: 2.8rem; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { 
            ChevronLeft, ChevronRight, List, Calendar: CalendarIcon, 
            Plus, Trash2, Save, X, Loader2, Sparkles, BarChart3, Tag, Info
        } = lucide;

        // --- 1. Firebase 配置 (資料永久存放) ---
        const appId = 'boba-warrior-2026-permanent-vault'; 
        
        // 【核心修正：若 GitHub 打開是空白，請將您的 Firebase Config 貼在下面的括號中】
        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        
        if (firebaseConfig.apiKey) {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
        }
        const auth = firebase.auth ? firebase.auth() : null;
        const db = firebase.firestore ? firebase.firestore() : null;

        // --- 2. 配置項 ---
        const SHOP_MAP = [
            { label: "五", full: "五十嵐" }, { label: "麻", full: "麻古" },
            { label: "可", full: "可不可" }, { label: "烏", full: "烏弄" },
            { label: "茗", full: "大茗" }, { label: "迷", full: "迷客夏" },
            { label: "龜", full: "龜記" }, { label: "沐", full: "一沐日" },
            { label: "桐", full: "五桐號" }, { label: "鮮", full: "鮮茶道" },
            { label: "爹", full: "老爹紅茶" }, { label: "其他", full: "" } 
        ];
        const SUGAR_LEVELS = ["無糖", "一分糖", "微糖", "半糖", "全糖", "固定"];
        const ICE_LEVELS = ["熱", "常溫", "去冰", "微冰", "少冰", "正常冰", "固定"];

        const CUSTOM_BG_CONFIG = [
            { "id": 1, "type": "GhostlyBoba", "x": 46, "y": -4, "size": 40, "rotate": -15, "opacity": 0.15 },
            { "id": 2, "type": "HeartLeaf", "x": 87, "y": 10, "size": 50, "rotate": 15, "opacity": 0.42 },
            { "id": 1767248305647, "type": "GhostlyBoba", "x": 6, "y": 64, "size": 47, "rotate": -45, "opacity": 0.25 },
            { "id": 1767248397697, "type": "SpiritTea", "x": 32, "y": 81, "size": 35, "rotate": 0, "opacity": 0.15 },
            { "id": 1767248416550, "type": "HeartLeaf", "x": 18, "y": 1, "size": 50, "rotate": -71, "opacity": 0.17 },
            { "id": 1767248444743, "type": "CupSpirit", "x": 74, "y": 75, "size": 35, "rotate": 6, "opacity": 0.31 },
            { "id": 1767248466715, "type": "SpiritTea", "x": 72, "y": 3, "size": 35, "rotate": 0, "opacity": 0.28 },
            { "id": 1767248507639, "type": "GhostlyBoba", "x": 45, "y": 29, "size": 55, "rotate": 40, "opacity": 0.09 },
            { "id": 1767248543979, "type": "HeartLeaf", "x": 10, "y": 31, "size": 56, "rotate": 0, "opacity": 0.13 },
            { "id": 1767248563880, "type": "CupSpirit", "x": 75, "y": 40, "size": 59, "rotate": -47, "opacity": 0.12 },
            { "id": 1767248611121, "type": "BobaPixie", "x": 89, "y": 70, "size": 60, "rotate": 0, "opacity": 0.15 },
            { "id": 1767248645388, "type": "BobaPixie", "x": -2, "y": 2, "size": 35, "rotate": 0, "opacity": 0.15 },
            { "id": 1767248691884, "type": "GhostlyBoba", "x": 52, "y": 71, "size": 35, "rotate": 0, "opacity": 0.15 },
            { "id": 1767248797209, "type": "SpiritTea", "x": 0, "y": 40, "size": 35, "rotate": 0, "opacity": 0.38 }
        ];

        const HeaderIcon = {
            GhostlyBoba: ({ opacity }) => (
                <svg viewBox="0 0 100 100" fill="currentColor" style={{ opacity }} className="w-full h-full"><path d="M25,35 Q25,25 50,25 Q75,25 75,35 L70,75 Q68,90 50,90 Q32,90 30,75 Z" /><circle cx="38" cy="58" r="5" fill="#FFB1B1" opacity="0.6" /><circle cx="62" cy="58" r="5" fill="#FFB1B1" opacity="0.6" /><g stroke="#546E7A" strokeWidth="1" fill="none"><path d="M36,45 Q34,41 32,42" /><path d="M40,44 Q40,40 40,41" /><path d="M44,45 Q46,41 48,42" /></g><g fill="white"><circle cx="40" cy="50" r="6" /><circle cx="60" cy="50" r="6" /><circle cx="40" cy="50" r="3" fill="#546E7A" /><circle cx="60" cy="50" r="3" fill="#546E7A" /></g><path d="M47,65 Q50,68 53,65" stroke="white" strokeWidth="2.5" fill="none" /></svg>
            ),
            BobaPixie: ({ opacity }) => (
                <svg viewBox="0 0 100 100" fill="currentColor" style={{ opacity }} className="w-full h-full"><circle cx="50" cy="50" r="32" /><path d="M35,45 L37,50 L42,50 L38,53 L40,58 L35,55 L30,58 L32,53 L28,50 L33,50 Z" fill="white" /><path d="M65,45 L67,50 L72,50 L68,53 L70,58 L65,55 L60,58 L62,53 L58,50 L63,50 Z" fill="white" /><path d="M46,62 Q50,65 54,62" stroke="white" strokeWidth="2" fill="none" /></svg>
            ),
            HeartLeaf: ({ opacity }) => (
                <svg viewBox="0 0 100 100" fill="currentColor" style={{ opacity }} className="w-full h-full"><path d="M50,80 Q20,60 20,40 A15,15 0 0,1 50,30 A15,15 0 0,1 80,40 Q80,60 50,80" /><path d="M50,80 L50,30 M50,60 L35,45 M50,50 L65,35" stroke="white" strokeWidth="2.5" opacity="0.6" /></svg>
            ),
            CupSpirit: ({ opacity }) => (
                <svg viewBox="0 0 100 100" fill="currentColor" style={{ opacity }} className="w-full h-full"><path d="M30,50 Q30,85 50,85 Q70,85 70,50 Z" /><path d="M40,50 Q40,20 50,20 Q60,20 60,50" fill="white" opacity="0.6" /></svg>
            ),
            SpiritTea: ({ opacity }) => (
                <svg viewBox="0 0 100 100" fill="currentColor" style={{ opacity }} className="w-full h-full"><circle cx="50" cy="45" r="25" /><path d="M50,70 Q55,95 35,90 Q50,105 50,70" opacity="0.8" /></svg>
            )
        };

        const LiquidSoulBg = ({ className }) => (
            <svg viewBox="0 0 200 200" className={className}><path fill="currentColor" d="M44.7,-76.4C58.3,-69.2,70.1,-58.5,77.9,-45.5C85.8,-32.5,89.7,-17.2,88.7,-2.3C87.7,12.5,81.8,26.9,73.5,39.8C65.2,52.7,54.5,64.1,41.4,71.5C28.3,78.9,12.8,82.3,-2.2,85.7C-17.2,89.1,-31.6,92.5,-44.6,87.4C-57.6,82.3,-69.2,68.7,-77.3,53.8C-85.3,38.8,-89.9,22.6,-90.4,6.4C-90.9,-9.8,-87.3,-26,-79.1,-39.9C-70.9,-53.8,-58.1,-65.4,-44.1,-72.4C-30.1,-79.4,-15,-81.8,0.3,-82.3C15.6,-82.8,31.2,-83.5,44.7,-76.4Z" transform="translate(100 100)" /></svg>
        );

        const BobaCupIcon = ({ className }) => (
            <svg viewBox="0 0 24 24" fill="none" className={className} style={{display:'block'}}><rect x="13.5" y="4" width="1.5" height="3" rx="0.5" fill="currentColor"/><rect x="7" y="7" width="10" height="1.2" rx="0.6" fill="currentColor"/><path d="M8 8.2L9.2 17.5C9.3 18.1 9.7 18.5 10.3 18.5H13.7C14.3 18.5 14.7 18.1 14.8 17.5L16 8.2H8Z" fill="currentColor" opacity="0.8"/></svg>
        );

        function App() {
            const [user, setUser] = useState(null);
            const [isReady, setIsReady] = useState(false);
            const [curDate, setCurDate] = useState(new Date(2026, 0, 1));
            const [records, setRecords] = useState({});
            const [page, setPage] = useState(1);
            const [modal, setModal] = useState(false);
            const [editData, setEditData] = useState([]);
            const [selDate, setSelDate] = useState(null);
            const [detailCat, setDetailCat] = useState(null);

            useEffect(() => {
                if (!auth) { setIsReady(true); return; }
                const unsub = auth.onAuthStateChanged(async u => {
                    if (!u) {
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await auth.signInWithCustomToken(__initial_auth_token);
                            } else { await auth.signInAnonymously(); }
                        } catch (e) {}
                    }
                    setUser(u); setIsReady(true);
                });
                return () => unsub();
            }, []);

            useEffect(() => {
                if (!user || !db) return;
                const docRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('settings').doc('boba_records');
                return docRef.onSnapshot(docSnap => {
                    if (docSnap.exists()) setRecords(docSnap.data());
                });
            }, [user]);

            const drinkList = useMemo(() => {
                return Object.entries(records).sort((a,b) => a[0].localeCompare(b[0])).flatMap(([date, drinks]) => drinks);
            }, [records]);

            // --- 歸類邏輯 (1/3-1 規範) ---
            const statsGroups = useMemo(() => {
                const groups = { pure: [], pure_t: [], milk: [], milk_t: [], fruit: [], fruit_t: [], other: [] };
                const tKeys = ["珠", "圓", "椰", "Ｑ", "Q", "凍", "燕麥", "波", "角", "寒天", "粿", "波霸", "混珠", "粉條", "仙草", "愛玉"];
                const mKeys = ["奶", "拿鐵", "歐蕾", "鮮乳", "牛奶", "那提", "那堤", "拿提", "醇奶", "奶蓋"];
                const fKeys = ["汁", "檸檬", "果", "柚", "萄", "葡", "梅", "蜜", "橙", "芒", "梨", "蘋", "鳳梨", "桑", "芭", "旺來"];

                drinkList.forEach(d => {
                    const item = d.item || "";
                    let cat = "other";
                    if (item.includes("多多綠")) cat = "other";
                    else if ((d.shop || "").includes("五十嵐") && item.includes("一號")) cat = "pure_t";
                    else if (item.includes("芝芝")) {
                        cat = (tKeys.some(k => item.includes(k)) || fKeys.some(k => item.includes(k))) ? "milk_t" : "milk";
                    } else {
                        const hasT = tKeys.some(k => item.includes(k));
                        if (mKeys.some(k => item.includes(k))) cat = hasT ? "milk_t" : "milk";
                        else if (fKeys.some(k => item.includes(k)) || item.includes("旺來")) cat = hasT ? "fruit_t" : "fruit";
                        else if (["茶", "紅", "綠", "青", "烏", "菁"].some(k => item.includes(k))) cat = hasT ? "pure_t" : "pure";
                        else cat = "other";
                    }
                    groups[cat].push(d);
                });
                const total = drinkList.length || 1;
                return [
                    { label: "純茶", items: groups.pure, color: "bg-[#D8A7B1]" },
                    { label: "純茶+料", items: groups.pure_t, color: "bg-[#E7C6C6]" },
                    { label: "乳香", items: groups.milk, color: "bg-[#D8A7B1]" },
                    { label: "乳香+料", items: groups.milk_t, color: "bg-[#E7C6C6]" },
                    { label: "果韻", items: groups.fruit, color: "bg-[#D8A7B1]" },
                    { label: "果韻+料", items: groups.fruit_t, color: "bg-[#E7C6C6]" },
                    { label: "其他", items: groups.other, color: "bg-[#B6A19E]" }
                ].map(g => ({ ...g, count: g.items.length, p: (g.items.length / total) * 100 }));
            }, [drinkList]);

            const currentMonth = currentDate.getMonth();
            const stats = useMemo(() => {
                let mC=0, mA=0, yC=0, yA=0;
                Object.entries(records).forEach(([d, drinks]) => {
                    const p = d.split('-');
                    if (p[0]==='2026') {
                        yC += drinks.length; yA += drinks.reduce((s, x) => s + (Number(x.price)||0), 0);
                        if (parseInt(p[1])===currentMonth+1) {
                            mC += drinks.length; mA += drinks.reduce((s, x) => s + (Number(x.price)||0), 0);
                        }
                    }
                });
                return { mC, mA, yC, yA };
            }, [records, currentMonth]);

            const getAbbr = (full) => {
                const found = SHOP_MAP.find(s => s.full === full && s.full !== "");
                return found ? found.label : (full ? full.substring(0,1) : "其");
            };

            if (!isReady) return <div className="min-h-screen flex items-center justify-center"><Loader2 className="animate-spin text-[#A3B18A]" /></div>;

            return (
                <div className="max-w-4xl mx-auto p-4 safe-area-bottom pb-20">
                    <nav className="mb-4 flex justify-end gap-2">
                        <button onClick={() => setPage(1)} className={`px-4 py-2 rounded-full text-[10px] md:text-xs font-black border transition-all ${page === 1 ? 'bg-[#A3B18A] text-white shadow-md' : 'bg-white text-[#A3B18A] border-[#A3B18A]'}`}>日曆紀錄</button>
                        <button onClick={() => setPage(2)} className={`px-4 py-2 rounded-full text-[10px] md:text-xs font-black border transition-all ${page === 2 ? 'bg-[#A3B18A] text-white shadow-md' : 'bg-white text-[#A3B18A] border-[#A3B18A]'}`}>飲品清單</button>
                        <button onClick={() => setPage(3)} className={`px-4 py-2 rounded-full text-[10px] md:text-xs font-black border transition-all ${page === 3 ? 'bg-[#A3B18A] text-white shadow-md' : 'bg-white text-[#A3B18A] border-[#A3B18A]'}`}>種類分析</button>
                    </nav>

                    {page === 1 && (
                        <div className="animate-in">
                            <header className="relative mb-6 py-6 md:py-8 px-6 rounded-2xl bg-[#FFEDD5] text-[#B45309] border-4 border-[#B45309] text-center overflow-hidden">
                                <div className="absolute inset-0 pointer-events-none">
                                    {CUSTOM_BG_CONFIG.map(c => (
                                        <div key={c.id} className="absolute" style={{ left: `${c.x}%`, top: `${c.y}%`, width: `${c.size}px`, height: `${c.size}px`, transform: `rotate(${c.rotate}deg)`, color: '#B45309' }}>
                                            {React.createElement(HeaderIcon[c.type], { opacity: c.opacity })}
                                        </div>
                                    ))}
                                </div>
                                <h1 className="relative z-10 text-[1.8rem] md:text-[3.8rem] font-black leading-tight">2026液態靈魂收集冊</h1>
                                <p className="relative z-10 text-[#B45309]/70 font-bold text-xs md:text-2xl tracking-widest">每一杯液態靈魂，都是對日常的微小補給</p>
                            </header>

                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                {[
                                    { l: '當月杯數', v: stats.mC, t: 'text-[#1E40AF]', b: 'border-[#60A5FA]' },
                                    { l: '當月金額', v: `$${stats.mA}`, t: 'text-[#6B21A8]', b: 'border-[#A855F7]' },
                                    { l: '年度杯數', v: stats.yC, t: 'text-[#334155]', b: 'border-[#94A7AE]' },
                                    { l: '年度金額', v: `$${stats.yA}`, t: 'text-[#701A75]', b: 'border-[#B7A4B3]' }
                                ].map((item, i) => (
                                    <div key={i} className={`relative bg-white p-3 rounded-2xl shadow-sm border-2 ${item.b} border-opacity-30 text-center flex flex-col justify-center min-h-[60px] overflow-hidden`}>
                                        <LiquidSoulBg className={`absolute -top-4 -right-4 w-20 h-20 opacity-10 ${item.t} transform rotate-12`} />
                                        <div className="relative z-10 leading-none">
                                            <p className={`stats-text-label ${item.t} font-black uppercase mb-1`}>{item.l}</p>
                                            <p className={`stats-text-value ${item.t} font-black`}>{item.v}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <div className="bg-white rounded-[3rem] shadow-2xl border border-slate-100 overflow-hidden mb-6">
                                <div className="bg-[#A3B18A] p-4 flex justify-between items-center text-white font-black">
                                    <button onClick={() => setCurDate(new Date(2026, currentMonth - 1))} className="p-2 active:scale-90"><ChevronLeft size={32} /></button>
                                    <h2 className="text-2xl tracking-widest">2026年 {currentMonth + 1}月</h2>
                                    <button onClick={() => setCurDate(new Date(2026, currentMonth + 1))} className="p-2 active:scale-90"><ChevronRight size={32} /></button>
                                </div>
                                <div className="p-4 grid grid-cols-7 gap-1.5 md:gap-2">
                                    {['日', '一', '二', '三', '四', '五', '六'].map(d => <div key={d} className="text-center text-[10px] font-black text-slate-300 uppercase">{d}</div>)}
                                    {Array.from({ length: new Date(2026, currentMonth, 1).getDay() }).map((_, i) => <div key={i}></div>)}
                                    {Array.from({ length: new Date(2026, currentMonth + 1, 0).getDate() }).map((_, i) => {
                                        const day = i + 1; const ds = `2026-${currentMonth + 1}-${day}`; const dr = records[ds] || [];
                                        const now = new Date(); const isT = now.getFullYear() === 2026 && now.getMonth() === currentMonth && now.getDate() === day;
                                        const bg = dr.length > 0 ? (dr.length > 1 ? 'bg-[#FFEDD5] text-orange-600' : 'bg-[#FEF9C3] text-yellow-700') : 'bg-slate-50 text-slate-300';
                                        return (
                                            <button key={day} onClick={() => { setSelectedDate(ds); setEditData(dr); setModal(true); }} className={`h-14 md:h-24 rounded-2xl p-1 text-left ${isT && dr.length === 0 ? 'bg-blue-50 text-blue-400' : bg} ${isT ? 'ring-2 ring-blue-400 ring-inset' : ''} border border-transparent overflow-hidden flex flex-col transition-all cursor-pointer`}>
                                                <span className="text-[10px] md:text-xs font-black opacity-40 leading-none">{day}</span>
                                                <div className="flex-1 flex items-center justify-center">
                                                    <div className={`grid ${dr.length > 2 ? 'grid-cols-2 gap-x-1' : 'grid-cols-1'} place-items-center`}>
                                                        {dr.slice(0, 4).map((_, idx) => <BobaCupIcon key={idx} className="w-5 h-5 md:w-8 md:h-8" />)}
                                                    </div>
                                                </div>
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    )}

                    {page === 2 && (
                        <div className="animate-in slide-in-from-bottom duration-500">
                            <div className="bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border-[3px] border-blue-100 min-h-[500px] flex flex-col">
                                <div className="bg-gradient-to-r from-blue-500 to-cyan-400 py-6 text-white text-center flex items-center justify-center font-black"><h2 className="text-xl md:text-3xl tracking-widest flex items-center gap-2 font-black"><Sparkles /> 2026全年度飲用軌跡</h2></div>
                                <div className="flex-1 py-5 pr-5 pl-0 md:pl-2 bg-slate-50/30">
                                    <div className="bg-white rounded-3xl p-4 border border-blue-50 shadow-sm space-y-0.5">
                                        {drinkList.map((drink, index) => (
                                            <div key={index} className="text-[13px] md:text-base text-slate-700 flex items-baseline gap-1 whitespace-nowrap overflow-hidden">
                                                <span className="text-blue-300 text-[10px] min-w-[20px] text-right font-black flex-shrink-0">{index + 1}.</span>
                                                <div className="flex-1 truncate"><span className="font-black">{drink.item}</span><span className="font-light text-slate-500 text-[11px] md:text-sm"><span className="mx-1"> </span>{drink.sugar}{drink.ice}({getAbbr(drink.shop)})</span></div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {page === 3 && (
                        <div className="animate-in zoom-in-95 duration-500 relative">
                            <div className="bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border-[3px] border-[#E7C6C6] min-h-[500px] flex flex-col relative">
                                <div className="bg-gradient-to-r from-[#B6A19E] to-[#A69695] py-8 text-white text-center font-black z-10"><h2 className="text-2xl md:text-4xl tracking-widest font-black">液態靈魂成分分析</h2></div>
                                <div className="flex-1 p-5 md:p-10 space-y-8 z-10 overflow-y-auto">
                                    <div className="grid grid-cols-2 gap-4 md:gap-8">
                                        {statsGroups.slice(0, 6).map((cat, idx) => (
                                            <button key={idx} onClick={() => setDetailCat(cat)} className="bg-white/80 backdrop-blur-sm rounded-[2rem] p-6 border border-[#E7C6C6] flex flex-col items-center shadow-sm active:scale-95 transition-transform group relative overflow-hidden">
                                                <p className="text-xl md:text-3xl font-black text-slate-500 mb-2 uppercase">{cat.label}</p>
                                                <div className="flex items-baseline gap-1"><span className="text-3xl md:text-5xl font-black text-slate-700">{cat.count}</span><span className="text-xs opacity-30 font-bold">杯</span></div>
                                                <div className="w-full max-w-[120px] bg-slate-100 rounded-full h-2 mt-4 overflow-hidden"><div className={`h-full ${cat.color} opacity-80 transition-all duration-1000`} style={{ width: `${Math.max(cat.p, 5)}%` }}></div></div>
                                                <div className="absolute top-2 right-4 opacity-0 group-hover:opacity-30"><Info size={16} /></div>
                                            </button>
                                        ))}
                                        <button onClick={() => setDetailCat(statsGroups[6])} className="col-span-2 bg-white/80 rounded-[2rem] p-8 border border-[#E7C6C6] flex flex-col items-center active:scale-[0.98] transition-transform group relative overflow-hidden">
                                            <p className="text-xl md:text-3xl font-black text-slate-500 mb-2 uppercase">{statsGroups[6].label}</p>
                                            <div className="flex items-baseline gap-1"><span className="text-4xl md:text-6xl font-black text-slate-700">{statsGroups[6].count}</span><span className="text-sm opacity-30 font-bold">杯</span></div>
                                            <div className="w-full max-w-[200px] bg-slate-100 rounded-full h-2.5 mt-4 overflow-hidden"><div className={`h-full ${statsGroups[6].color} opacity-80 transition-all duration-1000`} style={{ width: `${Math.max(statsGroups[6].p, 5)}%` }}></div></div>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {modal && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-md z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-xl rounded-[2.5rem] p-6 shadow-2xl max-h-[90vh] flex flex-col relative overflow-hidden">
                                <button onClick={() => setModal(false)} className="absolute top-6 right-6 p-2 active:scale-90"><X /></button>
                                <h3 className="text-xl font-black mb-6">日期：{selectedDate}</h3>
                                <div className="space-y-4 overflow-y-auto no-scrollbar pr-1">
                                    {editData.map((d, i) => (
                                        <div key={i} className="p-4 bg-slate-50 rounded-2xl relative border">
                                            <button onClick={() => setEditData(editData.filter((_, idx) => idx !== i))} className="absolute -top-3 -right-3 bg-red-500 text-white rounded-full p-2 shadow-lg active:scale-90"><Trash2 size={16} /></button>
                                            <div className="flex flex-wrap gap-1.5 mb-2">
                                                {SHOP_MAP.map(opt => <button key={opt.label} onClick={() => { const n = [...editData]; n[i].shop = opt.full; setEditData(n); }} className={`px-2.5 py-1 rounded-xl text-xs font-black border transition-all ${d.shop === opt.full && opt.full !== "" ? 'bg-[#A3B18A] text-white border-[#A3B18A]' : 'bg-white text-slate-600 border-slate-200'}`}>{opt.label}</button>)}
                                            </div>
                                            <input type="text" value={d.shop} onChange={e => { const n = [...editData]; n[i].shop = e.target.value; setEditData(n); }} placeholder="店名" className="w-full mb-2 p-2.5 rounded-xl text-sm font-bold bg-white outline-none border-none" />
                                            <input type="text" value={d.item} onChange={e => { const n = [...editData]; n[i].item = e.target.value; setEditData(n); }} placeholder="飲料名稱" className="w-full mb-2 p-2.5 rounded-xl text-sm bg-white outline-none border-none" />
                                            <input type="number" value={d.price || ''} onChange={e => { const n = [...editData]; n[i].price = Number(e.target.value); setEditData(n); }} placeholder="價格" className="w-full p-2.5 rounded-xl text-sm font-black text-[#588157] bg-white outline-none border-none" />
                                            <div className="flex flex-wrap gap-1 mt-3">{SUGAR_LEVELS.map(l => <button key={l} onClick={() => { const n = [...editData]; n[i].sugar = l; setEditData(n); }} className={`px-2.5 py-1 rounded-full text-[10px] font-bold border transition-all ${d.sugar === l ? 'bg-orange-100 text-orange-600 border-orange-200 shadow-sm' : 'bg-white text-slate-400 border-transparent'}`}>{l}</button>)}</div>
                                            <div className="flex flex-wrap gap-1 mt-2">{ICE_LEVELS.map(l => <button key={l} onClick={() => { const n = [...editData]; n[i].ice = l; setEditData(n); }} className={`px-2.5 py-1 rounded-full text-[10px] font-bold border transition-all ${d.ice === l ? 'bg-blue-100 text-blue-600 border-blue-200 shadow-sm' : 'bg-white text-slate-400 border-transparent'}`}>{l}</button>)}</div>
                                        </div>
                                    ))}
                                    {editData.length < 4 && <button onClick={() => setEditData([...editData, { shop: '', item: '', sugar: '無糖', ice: '去冰', price: 0 }])} className="w-full py-4 border-2 border-dashed border-[#A3B18A] text-[#A3B18A] rounded-2xl font-black active:bg-[#A3B18A]/10 transition-colors">+ 新增紀錄</button>}
                                </div>
                                <button onClick={async () => {
                                    const updated = { ...records, [selectedDate]: editData.filter(d => d.item || d.shop) };
                                    if (updated[selectedDate].length === 0) delete updated[selectedDate];
                                    await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('settings').doc('boba_records').set(updated);
                                    setModal(false);
                                }} className="w-full mt-6 bg-[#A3B18A] text-white py-4 rounded-xl font-black shadow-lg active:scale-95 transition-all">儲存紀錄</button>
                            </div>
                        </div>
                    )}

                    {detailCat && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden max-h-[80vh] flex flex-col border-[4px] border-[#E7C6C6]">
                                <div className={`p-6 flex justify-between items-center text-white ${detailCat.color}`}>
                                    <h3 className="text-xl font-black tracking-widest flex items-center gap-2"><Tag size={20} /> {detailCat.label} (共 {detailCat.count} 杯)</h3>
                                    <button onClick={() => setDetailCat(null)} className="p-2 bg-black/10 rounded-full active:scale-90"><X size={20} /></button>
                                </div>
                                <div className="flex-1 p-6 overflow-y-auto bg-slate-50/50">
                                    <div className="bg-white rounded-3xl p-4 border border-slate-100 shadow-sm space-y-1">
                                        {detailCat.items.map((drink, idx) => (
                                            <div key={idx} className="text-sm md:text-base text-slate-700 flex items-baseline gap-2 py-0.5 border-b border-slate-50 last:border-0">
                                                <span className="text-[#D8A7B1] text-xs font-black min-w-[15px]">{idx + 1}.</span>
                                                <span className="font-black truncate flex-1">{drink.item}</span>
                                                <span className="text-[10px] md:text-xs text-slate-400 font-medium whitespace-nowrap">{drink.sugar}{drink.ice} ({getAbbr(drink.shop)})</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="p-4 bg-slate-100/50 text-center"><button onClick={() => setDetailCat(null)} className="px-8 py-2 bg-slate-400 text-white rounded-full text-xs font-black active:scale-95 transition-all">關閉明細</button></div>
                            </div>
                        </div>
                    )}

                    <footer className="max-w-4xl mx-auto mt-6 text-center text-slate-400 space-y-4 pb-4 px-2">
                        {page === 1 && (
                            <div className="flex flex-col items-center gap-4">
                                <div className="bg-white/50 py-2 px-6 rounded-full inline-flex border border-slate-100 shadow-sm gap-4 items-center">
                                    {[{ c: 'bg-[#FEF9C3]', l: '1杯' }, { c: 'bg-[#FFEDD5]', l: '2杯' }, { c: 'bg-[#FDBA74]', l: '3杯' }, { c: 'bg-[#FB923C]', l: '4杯' }].map((item, idx) => (
                                        <div key={idx} className="flex items-center gap-1.5 whitespace-nowrap"><div className={`w-4 h-4 rounded-md ${item.c}`}></div><span className="text-[10px] md:text-xs font-black">{item.l}</span></div>
                                    ))}
                                </div>
                                <p className="text-[10px] md:text-xs font-bold opacity-50 tracking-widest whitespace-nowrap">提示：點擊日曆格可新增或修改當日手搖紀錄</p>
                            </div>
                        )}
                        <p className="text-[10px] md:text-xs font-bold opacity-80 whitespace-nowrap uppercase tracking-widest">© 2026 液態靈魂收集冊</p>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

