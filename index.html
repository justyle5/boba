import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp, getApps } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot } from 'firebase/firestore';
import { 
  ChevronLeft, ChevronRight, X, Sparkles, Tag, Loader2, Info 
} from 'lucide-react';

// --- 1. Firebase 配置 (GitHub 部署手動填寫區) ---
const manualFirebaseConfig = {
 apiKey: "AIzaSyDVBpexFqyRaFfdJEUbjCVzMznR0i0fJSE",
  authDomain: "mybobatracker.firebaseapp.com",
  projectId: "mybobatracker",
  storageBucket: "mybobatracker.firebasestorage.app",
  messagingSenderId: "936525142564",
  appId: "1:936525142564:web:17aeb323f8f8d843d616b1"
};

// 自動偵測環境
const firebaseConfig = typeof __firebase_config !== 'undefined' 
  ? JSON.parse(__firebase_config) 
  : manualFirebaseConfig;

const appId = typeof __app_id !== 'undefined' ? __app_id : 'boba-warrior-2026-permanent-vault';
const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApps()[0];
const auth = getAuth(app);
const db = getFirestore(app);

// --- 2. 18:09 原始配置 (嚴禁修改) ---
const SHOP_MAP = [
  { label: "五", full: "五十嵐" }, { label: "麻", full: "麻古" },
  { label: "可", full: "可不可" }, { label: "烏", full: "烏弄" },
  { label: "茗", full: "大茗" }, { label: "迷", full: "迷客夏" },
  { label: "龜", full: "龜記" }, { label: "沐", full: "一沐日" },
  { label: "桐", full: "五桐號" }, { label: "鮮", full: "鮮茶道" },
  { label: "爹", full: "老爹紅茶" }, { label: "其他", full: "" } 
];
const SUGAR_LEVELS = ["無糖", "一分糖", "微糖", "半糖", "全糖", "固定"];
const ICE_LEVELS = ["熱", "常溫", "去冰", "微冰", "少冰", "正常冰", "固定"];

const GHOST_CONFIG = [
  { id: 1, type: "G", x: 46, y: -4, size: 40, r: -15, o: 0.15 },
  { id: 2, type: "H", x: 87, y: 10, size: 50, r: 15, o: 0.42 },
  { id: 3, type: "G", x: 6, y: 64, size: 47, r: -45, o: 0.25 },
  { id: 4, type: "S", x: 32, y: 81, size: 35, r: 0, o: 0.15 },
  { id: 5, type: "H", x: 18, y: 1, size: 50, r: -71, o: 0.17 },
  { id: 6, type: "C", x: 74, y: 75, size: 35, r: 6, o: 0.31 },
  { id: 7, type: "S", x: 72, y: 3, size: 35, r: 0, o: 0.28 },
  { id: 8, type: "G", x: 45, y: 29, size: 55, r: 40, o: 0.09 },
  { id: 9, type: "H", x: 10, y: 31, size: 56, r: 0, o: 0.13 },
  { id: 10, type: "C", x: 75, y: 40, size: 59, r: -47, o: 0.12 },
  { id: 11, type: "P", x: 89, y: 70, size: 60, r: 0, o: 0.15 },
  { id: 12, type: "P", x: -2, y: 2, size: 35, r: 0, o: 0.15 },
  { id: 13, type: "G", x: 52, y: 71, size: 35, r: 0, o: 0.15 },
  { id: 14, type: "S", x: 0, y: 40, size: 35, r: 0, o: 0.38 }
];

const GhostIcon = ({ opacity }) => (
  <svg viewBox="0 0 100 100" fill="currentColor" style={{ opacity }} className="w-full h-full"><path d="M25,35 Q25,25 50,25 Q75,25 75,35 L70,75 Q68,90 50,90 Q32,90 30,75 Z" /><circle cx="38" cy="58" r="5" fill="#FFB1B1" opacity="0.6" /><circle cx="62" cy="58" r="5" fill="#FFB1B1" opacity="0.6" /><g fill="white"><circle cx="40" cy="50" r="6" /><circle cx="60" cy="50" r="6" /></g><path d="M47,65 Q50,68 53,65" stroke="white" strokeWidth="2.5" fill="none" /></svg>
);
const HeartIcon = ({ opacity }) => (
  <svg viewBox="0 0 100 100" fill="currentColor" style={{ opacity }} className="w-full h-full"><path d="M50,80 Q20,60 20,40 A15,15 0 0,1 50,30 A15,15 0 0,1 80,40 Q80,60 50,80" /><path d="M50,80 L50,30 M50,60 L35,45 M50,50 L65,35" stroke="white" strokeWidth="2.5" opacity="0.6" /></svg>
);
const CupIcon = ({ opacity }) => (
  <svg viewBox="0 0 100 100" fill="currentColor" style={{ opacity }} className="w-full h-full"><path d="M30,50 Q30,85 50,85 Q70,85 70,50 Z" /><path d="M40,50 Q40,20 50,20 Q60,20 60,50" fill="white" opacity="0.6" /></svg>
);
const SpiritIcon = ({ opacity }) => (
  <svg viewBox="0 0 100 100" fill="currentColor" style={{ opacity }} className="w-full h-full"><circle cx="50" cy="45" r="25" /><path d="M50,70 Q55,95 35,90 Q50,105 50,70" opacity="0.8" /></svg>
);
const PixieIcon = ({ opacity }) => (
  <svg viewBox="0 0 100 100" fill="currentColor" style={{ opacity }} className="w-full h-full"><circle cx="50" cy="50" r="32" /><path d="M35,45 L37,50 L42,50 L38,53 L40,58 L35,55 L30,58 L32,53 L28,50 L33,50 Z" fill="white" /><path d="M65,45 L67,50 L72,50 L68,53 L70,58 L65,55 L60,58 L62,53 L58,50 L63,50 Z" fill="white" /><path d="M46,62 Q50,65 54,62" stroke="white" strokeWidth="2" fill="none" /></svg>
);

const BobaCupLegend = ({ className }) => (
  <svg viewBox="0 0 24 24" fill="none" className={className} style={{display:'block'}}><rect x="13.5" y="4" width="1.5" height="3" rx="0.5" fill="currentColor"/><rect x="7" y="7" width="10" height="1.2" rx="0.6" fill="currentColor"/><path d="M8 8.2L9.2 17.5C9.3 18.1 9.7 18.5 10.3 18.5H13.7C14.3 18.5 14.7 18.1 14.8 17.5L16 8.2H8Z" fill="currentColor" opacity="0.8"/></svg>
);

const LiquidSoulBlob = ({ className }) => (
  <svg viewBox="0 0 200 200" className={className}><path fill="currentColor" d="M44.7,-76.4C58.3,-69.2,70.1,-58.5,77.9,-45.5C85.8,-32.5,89.7,-17.2,88.7,-2.3C87.7,12.5,81.8,26.9,73.5,39.8C65.2,52.7,54.5,64.1,41.4,71.5C28.3,78.9,12.8,82.3,-2.2,85.7C-17.2,89.1,-31.6,92.5,-44.6,87.4C-57.6,82.3,-69.2,68.7,-77.3,53.8C-85.3,38.8,-89.9,22.6,-90.4,6.4C-90.9,-9.8,-87.3,-26,-79.1,-39.9C-70.9,-53.8,-58.1,-65.4,-44.1,-72.4C-30.1,-79.4,-15,-81.8,0.3,-82.3C15.6,-82.8,31.2,-83.5,44.7,-76.4Z" transform="translate(100 100)" /></svg>
);

// --- 3. 主應用程式 ---
export default function App() {
  const [user, setUser] = useState(null);
  const [isReady, setIsReady] = useState(false);
  const [curDate, setCurDate] = useState(new Date(2026, 0, 1));
  const [records, setRecords] = useState({});
  const [page, setPage] = useState(1);
  const [modal, setModal] = useState(false);
  const [editData, setEditData] = useState([]);
  const [selDate, setSelDate] = useState(null);
  const [detailCat, setDetailCat] = useState(null);

  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else if (firebaseConfig.apiKey) {
        await signInAnonymously(auth).catch(() => {});
      }
    };
    initAuth();
    const unsub = onAuthStateChanged(auth, u => { setUser(u); setIsReady(true); });
    return () => unsub();
  }, []);

  useEffect(() => {
    if (!user) return;
    const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'boba_records');
    return onSnapshot(docRef, (snap) => { if (snap.exists()) setRecords(snap.data()); });
  }, [user]);

  const drinkList = useMemo(() => Object.entries(records).sort((a,b) => a[0].localeCompare(b[0])).flatMap(([date, drinks]) => drinks), [records]);

  // 18:09 原始分類邏輯
  const statsGroups = useMemo(() => {
    const groups = { pure: [], pure_t: [], milk: [], milk_t: [], fruit: [], fruit_t: [], other: [] };
    const tKeys = ["珠", "圓", "椰", "Ｑ", "Q", "凍", "燕麥", "波", "角", "寒天", "粿", "仙草", "愛玉"];
    drinkList.forEach(d => {
      const item = d.item || ""; let cat = "other";
      if (item.includes("奶") || item.includes("拿鐵")) cat = tKeys.some(k => item.includes(k)) ? "milk_t" : "milk";
      else if (item.includes("汁") || item.includes("檸檬") || item.includes("果")) cat = tKeys.some(k => item.includes(k)) ? "fruit_t" : "fruit";
      else if (["茶", "紅", "綠", "青", "烏"].some(k => item.includes(k))) cat = tKeys.some(k => item.includes(k)) ? "pure_t" : "pure";
      groups[cat].push(d);
    });
    const total = drinkList.length || 1;
    return [
      { label: "純茶", items: groups.pure, color: "bg-[#D8A7B1]" },
      { label: "純茶+料", items: groups.pure_t, color: "bg-[#E7C6C6]" },
      { label: "乳香", items: groups.milk, color: "bg-[#D8A7B1]" },
      { label: "乳香+料", items: groups.milk_t, color: "bg-[#E7C6C6]" },
      { label: "果韻", items: groups.fruit, color: "bg-[#D8A7B1]" },
      { label: "果韻+料", items: groups.fruit_t, color: "bg-[#E7C6C6]" },
      { label: "其他", items: groups.other, color: "bg-[#B6A19E]" }
    ].map(g => ({ ...g, count: g.items.length, p: (g.items.length / total) * 100 }));
  }, [drinkList]);

  const mIdx = curDate.getMonth();
  const summary = useMemo(() => {
    let mC=0, mA=0, yC=0, yA=0;
    Object.entries(records).forEach(([d, drinks]) => {
      const p = d.split('-');
      if (p[0]==='2026') {
        yC += drinks.length; yA += drinks.reduce((s, x) => s + (Number(x.price)||0), 0);
        if (parseInt(p[1])===mIdx+1) { mC += drinks.length; mA += drinks.reduce((s, x) => s + (Number(x.price)||0), 0); }
      }
    });
    return { mC, mA, yC, yA };
  }, [records, mIdx]);

  const getAbbr = (full) => {
    const found = SHOP_MAP.find(s => s.full === full && s.full !== "");
    return found ? found.label : (full ? full.substring(0,1) : "其");
  };

  if (!isReady) return <div className="min-h-screen flex items-center justify-center font-sans text-slate-400">載入中...</div>;

  return (
    <div className="max-w-4xl mx-auto p-4 pb-20 font-sans text-slate-700 bg-[#FDFCF8] min-h-screen select-none overflow-x-hidden">
      {!firebaseConfig.apiKey && (
        <div className="bg-red-50 text-red-600 p-3 rounded-xl mb-4 text-center text-xs font-bold border border-red-100">
          Firebase 金鑰未填寫，僅供預覽。
        </div>
      )}

      <nav className="mb-4 flex justify-end gap-2">
        {[1, 2, 3].map(p => (
          <button key={p} onClick={() => setPage(p)} className={`px-4 py-2 rounded-full text-[10px] md:text-xs font-black border transition-all ${page === p ? 'bg-[#A3B18A] text-white shadow-md' : 'bg-white text-[#A3B18A] border-[#A3B18A]'}`}>
            {p === 1 ? '日曆紀錄' : p === 2 ? '飲品清單' : '種類分析'}
          </button>
        ))}
      </nav>

      {page === 1 && (
        <div className="animate-in">
          <header className="relative mb-6 py-8 px-6 rounded-2xl bg-[#FFEDD5] text-[#B45309] border-4 border-[#B45309] text-center overflow-hidden">
            <div className="absolute inset-0 pointer-events-none">
              {GHOST_CONFIG.map(c => {
                const Icon = c.type === 'G' ? GhostIcon : c.type === 'H' ? HeartIcon : c.type === 'C' ? CupIcon : c.type === 'S' ? SpiritIcon : PixieIcon;
                return <div key={c.id} className="absolute" style={{ left: `${c.x}%`, top: `${c.y}%`, width: `${c.size}px`, height: `${c.size}px`, transform: `rotate(${c.r}deg)`, color: '#B45309' }}><Icon opacity={c.o} /></div>;
              })}
            </div>
            <h1 className="relative z-10 text-[1.8rem] md:text-[3.8rem] font-black leading-tight whitespace-nowrap overflow-hidden">2026液態靈魂收集冊</h1>
            <p className="relative z-10 text-[#B45309]/70 font-bold text-xs md:text-2xl tracking-widest">每一杯液態靈魂，都是對日常的微小補給</p>
          </header>

          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            {[
              { l: '當月杯數', v: summary.mC, t: 'text-[#1E40AF]', b: 'border-[#60A5FA]' },
              { l: '當月金額', v: `$${summary.mA}`, t: 'text-[#6B21A8]', b: 'border-[#A855F7]' },
              { l: '年度杯數', v: summary.yC, t: 'text-[#334155]', b: 'border-[#94A7AE]' },
              { l: '年度金額', v: `$${summary.yA}`, t: 'text-[#701A75]', b: 'border-[#B7A4B3]' }
            ].map((item, i) => (
              <div key={i} className={`relative bg-white p-3 rounded-2xl shadow-sm border-2 ${item.b} border-opacity-30 text-center flex flex-col justify-center min-h-[70px] overflow-hidden`}>
                <LiquidSoulBlob className={`absolute -top-4 -right-4 w-20 h-20 opacity-[0.08] ${item.t} transform rotate-12`} />
                <div className="relative z-10 leading-none">
                  <p className={`font-black uppercase mb-1 text-[17px] md:text-[20px] ${item.t}`}>{item.l}</p>
                  <p className={`font-black text-[1.85rem] md:text-[2.8rem] ${item.t}`}>{item.v}</p>
                </div>
              </div>
            ))}
          </div>

          <div className="bg-white rounded-[3rem] shadow-2xl border border-slate-100 overflow-hidden mb-6">
            <div className="bg-[#A3B18A] p-4 flex justify-between items-center text-white font-black text-xl">
              <button onClick={() => setCurDate(new Date(2026, mIdx - 1))} className="p-2 active:scale-90"><ChevronLeft size={32} /></button>
              <h2 className="text-2xl tracking-widest font-black">2026年 {mIdx + 1}月</h2>
              <button onClick={() => setCurDate(new Date(2026, mIdx + 1))} className="p-2 active:scale-90"><ChevronRight size={32} /></button>
            </div>
            <div className="p-4 grid grid-cols-7 gap-1.5 md:gap-2">
              {['日', '一', '二', '三', '四', '五', '六'].map(d => <div key={d} className="text-center text-[10px] font-black text-slate-300 uppercase">{d}</div>)}
              {Array.from({ length: new Date(2026, mIdx, 1).getDay() }).map((_, i) => <div key={i}></div>)}
              {Array.from({ length: new Date(2026, mIdx + 1, 0).getDate() }).map((_, i) => {
                const day = i + 1; const ds = `2026-${mIdx + 1}-${day}`; const dr = records[ds] || [];
                const bg = dr.length > 0 ? (dr.length >= 4 ? 'bg-[#FB923C] text-white' : dr.length === 3 ? 'bg-[#FDBA74] text-orange-900' : dr.length === 2 ? 'bg-[#FFEDD5] text-orange-600' : 'bg-[#FEF9C3] text-yellow-700') : 'bg-slate-50 text-slate-300';
                return (
                  <button key={day} onClick={() => { setSelDate(ds); setEditData(dr); setModal(true); }} className={`h-14 md:h-24 rounded-2xl p-1 text-left ${bg} border border-transparent overflow-hidden flex flex-col transition-all cursor-pointer active:scale-95`}>
                    <span className="text-[10px] md:text-xs font-black opacity-40 leading-none">{day}</span>
                    <div className="flex-1 flex items-center justify-center">
                      <div className={`grid ${dr.length > 2 ? 'grid-cols-2 gap-x-1' : 'grid-cols-1'} place-items-center`}>
                        {dr.slice(0, 4).map((_, idx) => <BobaCupLegend key={idx} className="w-5 h-5 md:w-8 md:h-8" />)}
                      </div>
                    </div>
                  </button>
                );
              })}
            </div>
          </div>

          <footer className="mt-8 text-center pb-4 animate-in">
            <div className="inline-flex items-center gap-4 bg-white/50 py-2.5 px-6 rounded-full border border-slate-100 shadow-sm">
              {[{c:'bg-[#FEF9C3]',l:'1杯'},{c:'bg-[#FFEDD5]',l:'2杯'},{c:'bg-[#FDBA74]',l:'3杯'},{c:'bg-[#FB923C]',l:'4杯'}].map((item, idx) => (
                <div key={idx} className="flex items-center gap-1.5"><div className={`w-3.5 h-3.5 rounded-md ${item.c}`}></div><span className="text-[10px] font-black text-slate-400">{item.l}</span></div>
              ))}
            </div>
            <p className="text-[10px] font-black text-slate-300 tracking-[1.5px] uppercase mt-4">© 2026 液態靈魂收集冊</p>
          </footer>
        </div>
      )}

      {page === 2 && (
        <div className="animate-in slide-in-from-bottom duration-500">
          <div className="bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border-[3px] border-blue-100 min-h-[500px] flex flex-col">
            <div className="bg-gradient-to-r from-blue-500 to-cyan-400 py-6 text-white text-center font-black"><h2 className="text-xl md:text-2xl tracking-widest font-black flex items-center justify-center gap-2"><Sparkles size={20}/> ✨ 2026全年度飲用軌跡</h2></div>
            <div className="flex-1 p-5 bg-slate-50/30">
              <div className="bg-white rounded-3xl p-4 border border-blue-50 shadow-sm space-y-0.5 overflow-y-auto">
                {drinkList.map((drink, index) => (
                  <div key={index} className="text-[13px] md:text-base text-slate-700 flex items-baseline gap-1 whitespace-nowrap overflow-hidden">
                    <span className="text-blue-300 text-[10px] min-w-[22px] text-right font-black flex-shrink-0">{index + 1}.</span>
                    <div className="flex-1 truncate font-black">{drink.item} <span className="font-light text-slate-500 text-[11px] md:text-sm ml-1">{drink.sugar}/{drink.ice}({getAbbr(drink.shop)})</span></div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      )}

      {page === 3 && (
        <div className="animate-in zoom-in-95 duration-500">
          <div className="bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border-[3px] border-[#E7C6C6] min-h-[500px] flex flex-col">
            <div className="bg-[#B6A19E] py-8 text-white text-center font-black"><h2 className="text-2xl md:text-3xl tracking-widest font-black uppercase">液態靈魂成分分析</h2></div>
            <div className="flex-1 p-6 md:p-10 space-y-6 overflow-y-auto">
              <div className="grid grid-cols-2 gap-4 md:gap-8">
                {statsGroups.map((cat, idx) => (
                  <button key={idx} onClick={() => setDetailCat(cat)} className={`bg-white border border-[#E7C6C6] rounded-[2rem] p-6 text-center shadow-sm relative overflow-hidden active:scale-95 transition-transform ${idx === 6 ? 'col-span-2' : ''}`}>
                    <p className="text-[15px] font-black text-slate-400 mb-2 uppercase">{cat.label}</p>
                    <div className="flex items-baseline justify-center gap-1"><span className="font-black text-slate-700 leading-none" style={{ fontSize: idx === 6 ? '38px' : '32px' }}>{cat.count}</span><span className="text-xs font-bold text-slate-300 uppercase">杯</span></div>
                    <div className={`w-full ${idx === 6 ? 'max-w-[200px] mx-auto' : ''} bg-slate-50 h-3 rounded-full mt-4 overflow-hidden border border-slate-100`}><div className={`h-full ${cat.color} opacity-80 transition-all duration-1000`} style={{ width: `${Math.max(cat.p, 8)}%` }}></div></div>
                  </button>
                ))}
              </div>
            </div>
          </div>
        </div>
      )}

      {modal && (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-md z-50 flex items-center justify-center p-4">
          <div className="bg-white w-full max-w-xl rounded-[2.5rem] p-6 shadow-2xl max-h-[90vh] flex flex-col relative animate-in">
            <button onClick={() => setModal(false)} className="absolute top-6 right-6 p-2 text-slate-300 active:scale-90"><X size={24}/></button>
            <h3 className="text-xl font-black mb-6 text-slate-300 uppercase tracking-widest">日期：{selDate}</h3>
            <div className="space-y-4 overflow-y-auto no-scrollbar pr-1 pb-4">
              {editData.map((d, i) => (
                <div key={i} className="p-5 bg-slate-50 rounded-2xl relative border border-slate-100 group">
                  <button onClick={() => setEditData(editData.filter((_, idx) => idx !== i))} className="absolute -top-3 -right-3 bg-[#ff4d4f] text-white rounded-full w-8 h-8 flex items-center justify-center shadow-lg active:scale-90 z-10"><X size={16}/></button>
                  <div className="flex flex-wrap gap-1.5 mb-3">
                    {SHOP_MAP.map(opt => <button key={opt.label} onClick={() => { const n = [...editData]; n[i].shop = opt.full; setEditData(n); }} className={`px-2.5 py-1 rounded-xl text-[10px] font-black border transition-all ${d.shop === opt.full && opt.full !== "" ? 'bg-[#A3B18A] text-white border-[#A3B18A]' : 'bg-white text-slate-400 border-slate-200'}`}>{opt.label}</button>)}
                  </div>
                  <div className="space-y-2">
                    <input type="text" value={d.shop} onChange={e => { const n = [...editData]; n[i].shop = e.target.value; setEditData(n); }} placeholder="店名" className="w-full p-2 bg-white rounded-xl text-sm font-bold outline-none ring-offset-0 focus:ring-1 ring-[#A3B18A]" />
                    <input type="text" value={d.item} onChange={e => { const n = [...editData]; n[i].item = e.target.value; setEditData(n); }} placeholder="飲料名稱" className="w-full p-2 bg-white rounded-xl text-sm font-bold outline-none ring-offset-0 focus:ring-1 ring-[#A3B18A]" />
                    <input type="number" value={d.price || ''} onChange={e => { const n = [...editData]; n[i].price = Number(e.target.value); setEditData(n); }} placeholder="價格" className="w-full p-2 bg-white rounded-xl text-sm font-black text-[#588157] outline-none" />
                  </div>
                  <div className="flex flex-wrap gap-1 mt-4">{["無糖","一分","微糖","半糖","全糖","固定"].map(l => <button key={l} onClick={() => { const n = [...editData]; n[i].sugar = l; setEditData(n); }} className={`px-2 py-1 rounded-full text-[9px] font-bold border transition-all ${d.sugar === l ? 'bg-orange-100 text-orange-600 border-orange-200' : 'bg-white text-slate-300 border-transparent'}`}>{l}</button>)}</div>
                  <div className="flex flex-wrap gap-1 mt-2">{["熱","常溫","去冰","微冰","少冰","正常"].map(l => <button key={l} onClick={() => { const n = [...editData]; n[i].ice = l; setEditData(n); }} className={`px-2 py-1 rounded-full text-[9px] font-bold border transition-all ${d.ice === l ? 'bg-blue-100 text-blue-600 border-blue-200' : 'bg-white text-slate-300 border-transparent'}`}>{l}</button>)}</div>
                </div>
              ))}
              {editData.length < 4 && <button onClick={() => setEditData([...editData, { shop: '', item: '', sugar: '微糖', ice: '微冰', price: 0 }])} className="w-full py-4 border-2 border-dashed border-[#A3B18A] text-[#A3B18A] rounded-2xl font-black active:bg-[#A3B18A]/5">+ 新增飲品項目</button>}
            </div>
            <button onClick={async () => {
              const updated = { ...records, [selDate]: editData.filter(d => d.item || d.shop) };
              if (updated[selDate].length === 0) delete updated[selDate];
              if (db) await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'boba_records'), updated);
              setModal(false);
            }} className="w-full mt-2 bg-[#A3B18A] text-white py-5 rounded-2xl font-black shadow-xl active:scale-95 transition-all text-lg">儲存收集紀錄</button>
          </div>
        </div>
      )}

      {detailCat && (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
          <div className="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden max-h-[80vh] flex flex-col border-[4px] border-[#E7C6C6] animate-in">
            <div className={`p-6 flex justify-between items-center text-white ${detailCat.color}`}>
              <h3 className="text-xl font-black tracking-widest flex items-center gap-2 uppercase"><Tag size={20} /> {detailCat.label} (共 {detailCat.count} 杯)</h3>
              <button onClick={() => setDetailCat(null)} className="p-2 bg-black/10 rounded-full active:scale-90 transition-transform"><X size={20} /></button>
            </div>
            <div className="flex-1 p-6 overflow-y-auto bg-slate-50/50 no-scrollbar">
              <div className="bg-white rounded-3xl p-4 border border-slate-100 shadow-sm space-y-1.5">
                {detailCat.items.length === 0 ? <p className="text-center py-10 text-slate-300 font-black">目前無資料</p> : 
                  detailCat.items.map((drink, idx) => (
                    <div key={idx} className="text-sm md:text-base text-slate-700 flex items-baseline gap-2 py-1 border-b border-slate-50 last:border-0 leading-tight">
                      <span className="text-[#D8A7B1] text-xs font-black min-w-[15px] text-right">{idx + 1}.</span>
                      <div className="flex-1 truncate font-black">{drink.item} <span className="font-medium text-[10px] md:text-xs text-slate-400 ml-1">{drink.sugar}/{drink.ice} ({getAbbr(drink.shop)})</span></div>
                    </div>
                  ))
                }
              </div>
            </div>
            <div className="p-4 bg-slate-50/50 text-center border-t border-slate-100">
              <button onClick={() => setDetailCat(null)} className="px-10 py-2.5 bg-[#A3B18A] text-white rounded-full text-sm font-black active:scale-95 transition-all shadow-md">關閉明細</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

